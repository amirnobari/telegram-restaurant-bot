
const TelegramBot = require('node-telegram-bot-api')
const Order = require('../models/orderModel')
const Menu = require('../models/menuModel')
const UserInfo = require('../models/userInfoModel')
require('dotenv').config()
const bot = new TelegramBot(process.env.BOT_TOKEN, { polling: true })
const steps = {}
//ÿ™ŸÜÿ∏€åŸÖÿßÿ™ ÿ®ÿßÿ™ ⁄©Ÿá €åŸÖ ŸÖÿß⁄òŸàŸÑ ÿ¥ÿØŸá
const setupBot = () => {
    bot.onText(/\/start/, async (msg) => {
        const chatId = msg.chat.id
        const firstName = msg.from.first_name
        const lasttName = msg.from.last_name

        // ÿ∞ÿÆ€åÿ±Ÿá ŸÖÿ±ÿ≠ŸÑŸá ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ŸÖÿßÿ±Ÿá ÿ™ŸÑŸÅŸÜ Ÿà ÿ¢ÿØÿ±ÿ≥
        steps[chatId] = {
            step: 'waitForPhoneNumber',
            order: {
                chatId: chatId,
                items: []
            }
        }

        bot.sendMessage(chatId, ` Welcome, ${firstName} ${lasttName}! ‚ö†Ô∏è Please provide your phone number (Example: +98910000000):`, {
            reply_markup: {
                force_reply: true
            }
        })
    })
    // ÿßŸÑ⁄ØŸà€å ÿßÿπÿ™ÿ®ÿßÿ±ÿ≥ŸÜÿ¨€å ÿ¥ŸÖÿßÿ±Ÿá ÿ™ŸÑŸÅŸÜ (ŸÖÿ´ÿßŸÑ: +989123456789)
    const phonePattern = /^\+?[0-9]{12}$/ // ÿ™ÿ∫€å€åÿ± ÿßŸÑ⁄ØŸà ÿ®Ÿá 12 ÿπÿØÿØ ÿ®ÿ±ÿß€å ŸÖÿ∑ÿßÿ®ŸÇÿ™ ÿ®ÿß "+989" Ÿà 9 ÿ±ŸÇŸÖ Ÿæ€åÿ¥‚Äåÿ¥ŸÖÿßÿ±Ÿá ÿß€åÿ±ÿßŸÜ
    bot.on('callback_query', async (query) => {
        const chatId = query.message.chat.id
        const option = query.data
        if (steps[chatId]) {
            // const currentStep = steps[chatId]
            if (option === 'menu') {
                try {
                    const menuItems = await Menu.find({})
                    if (menuItems.length === 0) {
                        bot.sendMessage(chatId, 'There are no items available in the menu.')
                    } else {
                        const orderData = steps[chatId].order

                        let menuMessage = 'Please choose items from the menu:\n'
                        menuItems.forEach((item, index) => {
                            menuMessage += `${index + 1} - ${item.itemName} - ${item.price} üí≤ \n`

                            orderData.items.push({
                                menuId: item._id,
                                name: item.itemName,
                                price: item.price,
                                quantity: 0
                            })
                        })

                        bot.sendMessage(chatId, menuMessage, {
                            reply_markup: {
                                inline_keyboard: [
                                    ...menuItems.map((item, index) => {
                                        return [{ text: `+ ${item.itemName}`, callback_data: `add_${index}` }]
                                    }),
                                    [{ text: 'Confirm Order', callback_data: 'confirm' }]
                                ]
                            }
                        })
                        steps[chatId].step = 'chooseItems'
                    }
                } catch (error) {
                    console.error('Error fetching menu:', error)
                    bot.sendMessage(chatId, 'An error occurred while fetching the menu.')
                }


            } else if (option.startsWith('add_')) {
                const itemIndex = parseInt(option.split('_')[1])
                const currentStep = steps[chatId]

                if (currentStep && currentStep.step === 'chooseItems') {
                    const selectedMenuItem = currentStep.order.items[itemIndex]
                    selectedMenuItem.quantity += 1
                    console.log(selectedMenuItem)
                    // ÿ®Ÿá ÿ±Ÿàÿ≤ ÿ±ÿ≥ÿßŸÜ€å ÿØ⁄©ŸÖŸá‚ÄåŸáÿß ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ ÿ™ÿπÿØÿßÿØ ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØŸá
                    const updatedKeyboard = currentStep.order.items.map((item, index) => {
                        return [{ text: `${item.quantity}x ${item.name}`, callback_data: `add_${index}` }]
                    })

                    updatedKeyboard.push([{ text: 'Confirm Order', callback_data: 'confirm' }])

                    bot.sendMessage(chatId, 'üéâ You have added an item to your order üéâ.', {
                        reply_markup: {
                            inline_keyboard: updatedKeyboard
                        }
                    })

                    // ÿ∞ÿÆ€åÿ±Ÿá ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ≥ŸÅÿßÿ±ÿ¥ ÿ®Ÿá ÿ±Ÿàÿ≤ ÿ¥ÿØŸá
                    steps[chatId] = currentStep
                }
            } else if (option === 'confirm') {
                const currentStep = steps[chatId]
                //  console.log(currentStep)
                if (currentStep && currentStep.step === 'chooseItems') {
                    const totalItems = currentStep.order.items.reduce((total, item) => total + item.quantity, 0)
                    //  console.log(totalItems)

                    if (totalItems === 0) {
                        bot.sendMessage(chatId, '‚õî Your order basket is empty. Please choose items before confirming ‚õî.')
                    } else {
                        const orderTotal = currentStep.order.items.reduce((total, item) => {
                            return total + item.price * item.quantity
                        }, 0)
                        // console.log(orderTotal)
                        bot.sendMessage(chatId, `Your order total is: üí≤ ${orderTotal} . Please confirm your order by pressing the "Confirm" button below.`, {
                            reply_markup: {
                                inline_keyboard: [
                                    [{ text: 'Place Order', callback_data: 'place_order' }],
                                    [{ text: 'Cancel', callback_data: 'cancel_order' }]
                                ]
                            }
                        })

                        // Update the step to 'confirmOrder' and save the changes
                        currentStep.step = 'confirmOrder'
                        steps[chatId] = currentStep // Save the changes back to the steps object
                    }
                }
            } else if (option === 'place_order') {
                const currentStep = steps[chatId]
                //console.log(currentStep);
                if (currentStep && currentStep.step === 'confirmOrder') {
                    currentStep.order.customer = {}
                    if (currentStep.order.customer) {
                        const orderItems = currentStep.order.items.filter(item => item.quantity > 0) // ÿ≠ÿ∞ŸÅ ÿ¢€åÿ™ŸÖ‚ÄåŸáÿß€å€å ⁄©Ÿá ÿ™ÿπÿØÿßÿØÿ¥ÿßŸÜ 0 ÿßÿ≥ÿ™
                        if (orderItems.length > 0) {
                            // Create a new instance of the Order model
                            const order = new Order({
                                items: orderItems,
                            })

                            try {

                                // Save the order to the database
                                await order.save()

                                // Inform the user that the order has been placed
                                bot.sendMessage(chatId, 'üéâ Your order has been placed successfully üéâ.')

                                // Clean up the steps object
                                delete steps[chatId]
                            } catch (error) {
                                console.error('Error saving order:', error)
                                bot.sendMessage(chatId, 'An error occurred while placing your order.')
                            }
                        } else {
                            bot.sendMessage(chatId, 'Your order basket is empty. Please choose items before confirming üôè.')
                        }
                    }

                }
            }

        }
    })
    bot.on('text', async (msg) => {
        const chatId = msg.chat.id
        const text = msg.text
        const currentStep = steps[chatId]

        if (currentStep) {
            if (currentStep.step === 'waitForPhoneNumber') {
                const phoneNumber = text
                if (phonePattern.test(phoneNumber)) {
                    currentStep.userInfo = new UserInfo({
                        phoneNumber: phoneNumber,
                        address: '',
                        username: msg.from.first_name
                    })
                    await currentStep.userInfo.save()

                    bot.sendMessage(chatId, 'Phone number saved üëå. Please provide your address:', {
                        reply_markup: {
                            force_reply: true
                        }
                    })
                    currentStep.step = 'waitForAddress'
                    steps[chatId] = currentStep
                } else {
                    bot.sendMessage(chatId, '‚õî Invalid phone number. Please provide a valid phone number ‚õî.')
                }
            } else if (currentStep.step === 'waitForAddress') {
                const address = text
                //console.log(address)

                try {
                    currentStep.userInfo.address = address
                    await currentStep.userInfo.save()
                    bot.sendMessage(chatId, 'Address saved successfully üëå')
                    bot.sendMessage(chatId, '‚ö†Ô∏è For information about food allergies, call this number : 09367482353 ‚ö†Ô∏è')
                    delete steps[chatId] // Clear the steps for this chat
                } catch (error) {
                    console.error('Error saving address:', error)
                    bot.sendMessage(chatId, 'An error occurred while saving your address.')
                }


                try {
                    const menuItems = await Menu.find({})
                    if (menuItems.length === 0) {
                        bot.sendMessage(chatId, 'There are no items available in the menu.')
                    } else {
                        const orderData = {
                            chatId: chatId,
                            items: []
                        }
                        let menuMessage = 'Please choose items from the menu:\n'
                        menuItems.forEach((item, index) => {
                            menuMessage += `${index + 1} - ${item.itemName} - ${item.price} üí≤ \n`
                            orderData.items.push({
                                menuId: item._id,
                                name: item.itemName,
                                price: item.price,
                                quantity: 0
                            })
                        })
                        bot.sendMessage(chatId, menuMessage, {
                            reply_markup: {
                                inline_keyboard: [
                                    ...menuItems.map((item, index) => {
                                        return [{ text: `+ ${item.itemName}`, callback_data: `add_${index}` }]
                                    }),
                                    [{ text: 'Confirm Order', callback_data: 'confirm' }]
                                ]
                            }
                        })
                        steps[chatId] = {
                            step: 'chooseItems',
                            order: orderData
                        }
                    }
                } catch (error) {
                    console.error('Error fetching menu:', error)
                    bot.sendMessage(chatId, 'An error occurred while fetching the menu.')
                }
            }
        }
    })
}
module.exports = {
    setupBot
}